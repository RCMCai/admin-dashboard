<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rapid Reply - Live Support Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    }
    * {
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // N8N WEBHOOK CONFIGURATION - Using your webhook base
    const N8N_BASE = 'https://n8n.ie-manage.com/webhook/live-chat';
    const N8N_FETCH_SESSIONS = N8N_BASE + '-fetch-sessions';
    const N8N_SEND_MESSAGE = N8N_BASE + '-send-message';
    const N8N_CLOSE_SESSION = N8N_BASE + '-close-session';

    // Icon Components
    const MessageCircle = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    );

    const User = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
    );

    const Clock = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    );

    const Send = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );

    const XCircle = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
    );

    const Copy = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    );

    const Check = ({ className, ...props }) => (
      <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    );

    function AdminDashboard() {
      const [sessions, setSessions] = useState([]);
      const [selectedSession, setSelectedSession] = useState(null);
      const [message, setMessage] = useState('');
      const [filter, setFilter] = useState('active');
      const [userId, setUserId] = useState(null);
      const [loading, setLoading] = useState(true);
      const [copied, setCopied] = useState(false);
      const messagesEndRef = useRef(null);

      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const userIdParam = urlParams.get('userId');
        
        if (userIdParam) {
          setUserId(userIdParam);
          setLoading(false);
        } else {
          setLoading(false);
        }
      }, []);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [selectedSession?.messages]);

      const fetchSessions = async () => {
        if (!userId) return;

        try {
          const response = await fetch(`${N8N_FETCH_SESSIONS}?userId=${userId}`);
          const data = await response.json();
          
          if (data.sessions) {
            setSessions(data.sessions);
          }
        } catch (error) {
          console.error('Error fetching sessions:', error);
        }
      };

      useEffect(() => {
        if (userId) {
          fetchSessions();
          const interval = setInterval(fetchSessions, 5000);
          return () => clearInterval(interval);
        }
      }, [userId]);

      const sendMessage = async () => {
        if (!message.trim() || !selectedSession) return;

        const newMessage = {
          sender: 'agent',
          text: message,
          timestamp: new Date().toISOString()
        };

        try {
          await fetch(N8N_SEND_MESSAGE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: userId,
              sessionId: selectedSession.sessionId,
              message: newMessage
            })
          });

          const updatedSession = {
            ...selectedSession,
            messages: [...selectedSession.messages, newMessage]
          };
          setSelectedSession(updatedSession);
          setSessions(sessions.map(s => 
            s.sessionId === selectedSession.sessionId ? updatedSession : s
          ));
          setMessage('');
        } catch (error) {
          console.error('Error sending message:', error);
          alert('Failed to send message. Please try again.');
        }
      };

      const closeSession = async (sessionId) => {
        if (!confirm('Are you sure you want to close this session?')) return;

        try {
          await fetch(N8N_CLOSE_SESSION, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, sessionId })
          });

          setSessions(sessions.map(s => 
            s.sessionId === sessionId ? { ...s, status: 'closed' } : s
          ));
          if (selectedSession?.sessionId === sessionId) {
            setSelectedSession(null);
          }
        } catch (error) {
          console.error('Error closing session:', error);
          alert('Failed to close session. Please try again.');
        }
      };

      const copyEmbedCode = () => {
        const embedCode = `<iframe src="https://rcmcai.github.io/admin-dashboard/index.html?userId=${userId}" style="width: 100%; height: 800px; border: none; border-radius: 8px;" title="Live Support Dashboard"></iframe>`;
        navigator.clipboard.writeText(embedCode);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      const filteredSessions = sessions.filter(s => {
        if (filter === 'active') return s.status === 'active';
        if (filter === 'closed') return s.status === 'closed';
        return true;
      });

      const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      };

      const getTimeSince = (timestamp) => {
        const minutes = Math.floor((Date.now() - new Date(timestamp)) / 60000);
        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        return `${Math.floor(minutes / 60)}h ago`;
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-screen bg-gray-50">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading dashboard...</p>
            </div>
          </div>
        );
      }

      if (!userId) {
        return (
          <div className="flex items-center justify-center h-screen bg-gray-50">
            <div className="text-center max-w-md p-8 bg-white rounded-lg shadow-lg">
              <XCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
              <h2 className="text-2xl font-bold text-gray-800 mb-2">Access Denied</h2>
              <p className="text-gray-600 mb-4">No user ID provided in URL.</p>
              <p className="text-sm text-gray-500 font-mono bg-gray-50 p-3 rounded">
                Format: ?userId=YOUR_USER_ID
              </p>
            </div>
          </div>
        );
      }

      return (
        <div className="flex h-screen bg-gray-50">
          <div className="w-80 bg-white border-r border-gray-200 flex flex-col">
            <div className="p-4 border-b border-gray-200">
              <div className="flex items-center justify-between mb-3">
                <h1 className="text-xl font-bold text-gray-800">Live Support</h1>
                <button onClick={copyEmbedCode} className="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Copy embed code">
                  {copied ? <Check className="w-4 h-4 text-green-500" /> : <Copy className="w-4 h-4 text-gray-500" />}
                </button>
              </div>
              <p className="text-xs text-gray-500 mb-3 font-mono bg-gray-50 p-2 rounded truncate" title={userId}>
                ID: {userId.slice(0, 20)}...
              </p>
              <div className="flex gap-2">
                <button onClick={() => setFilter('active')} className={`flex-1 px-3 py-2 rounded text-sm font-medium transition-colors ${filter === 'active' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                  Active ({sessions.filter(s => s.status === 'active').length})
                </button>
                <button onClick={() => setFilter('closed')} className={`flex-1 px-3 py-2 rounded text-sm font-medium transition-colors ${filter === 'closed' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                  Closed
                </button>
              </div>
            </div>

            <div className="flex-1 overflow-y-auto">
              {filteredSessions.length === 0 ? (
                <div className="p-4 text-center text-gray-500">
                  <MessageCircle className="w-12 h-12 mx-auto mb-2 text-gray-300" />
                  <p>No {filter} sessions</p>
                  <p className="text-xs mt-2">Sessions appear when clients request support</p>
                </div>
              ) : (
                filteredSessions.map(session => (
                  <div key={session.sessionId} onClick={() => setSelectedSession(session)} className={`p-4 border-b border-gray-100 cursor-pointer transition-colors ${selectedSession?.sessionId === session.sessionId ? 'bg-blue-50 border-l-4 border-l-blue-500' : 'hover:bg-gray-50'}`}>
                    <div className="flex items-start justify-between mb-1">
                      <div className="flex items-center gap-2">
                        <User className="w-4 h-4 text-gray-400" />
                        <span className="font-medium text-gray-800">{session.clientEmail || 'Unknown'}</span>
                      </div>
                      <span className={`px-2 py-0.5 rounded text-xs font-medium ${session.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                        {session.status}
                      </span>
                    </div>
                    <p className="text-sm text-gray-600 mb-1">{session.clientPhone || 'No phone'}</p>
                    <div className="flex items-center gap-1 text-xs text-gray-500">
                      <Clock className="w-3 h-3" />
                      <span>{getTimeSince(session.startTime)}</span>
                      <span className="mx-1">•</span>
                      <span>{session.messages?.length || 0} messages</span>
                    </div>
                    {session.messages && session.messages.length > 0 && (
                      <p className="text-sm text-gray-500 mt-2 truncate">
                        {session.messages[session.messages.length - 1]?.text}
                      </p>
                    )}
                  </div>
                ))
              )}
            </div>
          </div>

          <div className="flex-1 flex flex-col">
            {selectedSession ? (
              <>
                <div className="bg-white border-b border-gray-200 p-4 flex items-center justify-between">
                  <div>
                    <h2 className="text-lg font-semibold text-gray-800">{selectedSession.clientEmail || 'Client'}</h2>
                    <p className="text-sm text-gray-500">
                      {selectedSession.clientPhone || 'No phone'} • Session: {selectedSession.sessionId.slice(0, 12)}...
                    </p>
                  </div>
                  <button onClick={() => closeSession(selectedSession.sessionId)} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors flex items-center gap-2">
                    <XCircle className="w-4 h-4" />
                    Close Session
                  </button>
                </div>

                <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                  {selectedSession.messages && selectedSession.messages.map((msg, idx) => (
                    <div key={idx} className={`flex ${msg.sender === 'agent' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-md px-4 py-2 rounded-lg ${msg.sender === 'agent' ? 'bg-blue-500 text-white' : msg.sender === 'bot' ? 'bg-purple-100 text-purple-800' : 'bg-white text-gray-800 shadow-sm'}`}>
                        {msg.sender === 'bot' && <span className="text-xs font-semibold block mb-1">AI ASSISTANT</span>}
                        {msg.sender === 'agent' && <span className="text-xs font-semibold block mb-1 opacity-90">YOU</span>}
                        {msg.sender === 'user' && <span className="text-xs font-semibold block mb-1 text-gray-500">CUSTOMER</span>}
                        <p className="whitespace-pre-wrap break-words">{msg.text}</p>
                        <p className={`text-xs mt-1 ${msg.sender === 'agent' ? 'text-blue-100' : 'text-gray-500'}`}>
                          {formatTime(msg.timestamp)}
                        </p>
                      </div>
                    </div>
                  ))}
                  <div ref={messagesEndRef} />
                </div>

                <div className="bg-white border-t border-gray-200 p-4">
                  <div className="flex gap-2">
                    <input 
                      type="text" 
                      value={message} 
                      onChange={(e) => setMessage(e.target.value)} 
                      onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && sendMessage()} 
                      placeholder="Type your message..." 
                      className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    />
                    <button 
                      onClick={sendMessage} 
                      disabled={!message.trim()} 
                      className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Send className="w-4 h-4" />
                      Send
                    </button>
                  </div>
                </div>
              </>
            ) : (
              <div className="flex-1 flex items-center justify-center text-gray-400">
                <div className="text-center">
                  <MessageCircle className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                  <p className="text-lg">Select a session to start chatting</p>
                  <p className="text-sm mt-2 text-gray-500">Waiting for customer support requests...</p>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<AdminDashboard />, document.getElementById('root'));
  </script>
</body>
</html>